{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="bg-success text-white text-center py-2 rounded mb-4">
  <h4 class="mb-0">ğŸ“Š Panel de Control - Nutripy ğŸ¥—</h4>
</div>


  <!-- Cards resumen -->
  <div class="row text-center mb-4">
  <!-- Pacientes -->
  <div class="col-md-4">
    <div class="card bg-primary-subtle border-primary shadow-sm">
      <div class="card-body">
        <h5 class="card-title text-primary">ğŸ‘¥ Pacientes</h5>
        <p class="display-6 mb-0">{{ total_pacientes }}</p>
      </div>
    </div>
  </div>

  <!-- Citas Programadas -->
  <div class="col-md-4">
    <div class="card bg-primary-subtle border-primary shadow-sm">
      <div class="card-body">
        <h5 class="card-title text-primary">ğŸ“… Citas Programadas</h5>
        <p class="display-6 mb-0">{{ total_citas }}</p>
      </div>
    </div>
  </div>

  <!-- Consultas Realizadas -->
  <div class="col-md-4">
    <div class="card bg-primary-subtle border-primary shadow-sm">
      <div class="card-body">
        <h5 class="card-title text-primary">ğŸ“ Consultas Realizadas</h5>
        <p class="display-6 mb-0">{{ total_consultas }}</p>
      </div>
    </div>
  </div>
</div>

  <!-- PrÃ³ximas citas y doctores activos -->
  <div class="row justify-content-center mb-4">
  <!-- PrÃ³ximas Citas -->
  <div class="col-md-6">
    <div class="card bg-success-subtle border-success mb-3">
      <div class="card-header fw-bold text-success">ğŸ“… PrÃ³ximas Citas</div>
      <div class="card-body p-2">
        <table class="table table-sm table-bordered mb-0">
          <thead class="table-light">
            <tr><th>Paciente</th><th>Fecha</th><th>Hora</th><th>Doctor</th></tr>
          </thead>
          <tbody>
            {% for c in proximas_citas %}
            <tr>
              <td>{{ c.paciente.nombre }}</td>
              <td>{{ c.fecha.strftime('%d/%m/%Y') }}</td>
              <td>{{ c.hora.strftime('%H:%M') }}</td>
              <td>{{ c.doctor.nombre }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Doctores Activos -->
  <div class="col-md-6">
    <div class="card bg-success-subtle border-success mb-3">
      <div class="card-header fw-bold text-success">ğŸ§‘â€âš•ï¸ Doctores Activos</div>
      <div class="card-body p-2">
        <table class="table table-sm table-bordered mb-0">
          <thead class="table-light">
            <tr><th>Nombre</th><th>Especialidad</th><th>Turno</th></tr>
          </thead>
          <tbody>
            {% for d in doctores_activos %}
            <tr>
              <td>{{ d.nombre }}</td>
              <td>{{ d.especialidad }}</td>
              <td>{{ d.turno }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


{% if alertas %}
<div class="alert bg-info-subtle border-info text-dark py-2 px-3 small rounded">
  <ul class="mb-0">
    {% for alerta in alertas %}
    <li class="mb-1">âš ï¸ {{ alerta }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

  <!-- GrÃ¡fico de modalidades -->
 <div class="row justify-content-center mt-4">
  <div class="col-md-4 text-center">
    <div class="card shadow-sm">
      <div class="card-header bg-dark text-white py-2">
        <h6 class="mb-0">ğŸ“ˆ Modalidad de Consultas</h6>
      </div>
      <div class="card-body p-2">
        <canvas id="graficoModalidad" width="250" height="150" style="max-width: 100%;"></canvas>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Datos seguros desde Jinja
  const modalidadesRaw = {{ modalidades|tojson }};
  // Transformar a etiquetas y valores, sanitizando nulos
  const labels = modalidadesRaw.map(m => (m[0] || 'Sin modalidad'));
  const values = modalidadesRaw.map(m => (m[1] || 0));

  // Si no hay datos, mostramos un grÃ¡fico vacÃ­o pero vÃ¡lido
  const dataLabels = labels.length ? labels : ['Sin datos'];
  const dataValues = values.length ? values : [0];

  const ctx = document.getElementById('graficoModalidad');
  if (ctx) {
    new Chart(ctx.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: dataLabels,
        datasets: [{
          data: dataValues,
          backgroundColor: ['#198754', '#0d6efd', '#ffc107', '#dc3545', '#6f42c1', '#20c997']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }
</script>
{% endblock %}
